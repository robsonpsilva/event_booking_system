@page "/events/create"
@using EventBookingSystem.Models
@using EventBookingSystem.Data
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using System.Linq 
@rendermode InteractiveServer

<PageTitle>Create New Event</PageTitle>

<div class="event-form-container">
    <h1 class="form-title">Create New Event</h1>

    <EditForm Model="@newEvent" OnValidSubmit="HandleCreateEvent" FormName="EventForm">
        <DataAnnotationsValidator />
        
        <!-- EVENT DATA SECTION -->
        <h2 class="section-title">1. Main Event Details</h2>
        <div class="grid-layout grid-full-span">
            
            <!-- Event Name -->
            <div>
                <label for="name" class="form-label">Event Name</label>
                <InputText id="name" @bind-Value="newEvent.Name" class="form-input" />
                <ValidationMessage For="@(() => newEvent.Name)" class="text-sm text-red-600 mt-1" />
            </div>

            <!-- Location -->
            <div>
                <label for="location" class="form-label">Location</label>
                <InputText id="location" @bind-Value="newEvent.Location" class="form-input" />
                <ValidationMessage For="@(() => newEvent.Location)" class="text-sm text-red-600 mt-1" />
            </div>

            <!-- Start Date -->
            <div>
                <label for="startDate" class="form-label">Start Date and Time</label>
                <InputDate id="startDate" @bind-Value="newEvent.StartDate" class="form-input" />
                <ValidationMessage For="@(() => newEvent.StartDate)" class="text-sm text-red-600 mt-1" />
            </div>

            <!-- End Date -->
            <div>
                <label for="endDate" class="form-label">End Date and Time</label>
                <InputDate id="endDate" @bind-Value="newEvent.EndDate" class="form-input" />
                <ValidationMessage For="@(() => newEvent.EndDate)" class="text-sm text-red-600 mt-1" />
            </div>

            <!-- Max Capacity -->
            <div class="md:col-span-2">
                <label for="maxCapacity" class="form-label">Maximum Capacity</label>
                <InputNumber id="maxCapacity" @bind-Value="newEvent.MaxCapacity" class="form-input" />
                <ValidationMessage For="@(() => newEvent.MaxCapacity)" class="text-sm text-red-600 mt-1" />
            </div>

            <!-- Description -->
            <div class="md:col-span-2">
                <label for="description" class="form-label">Description</label>
                <InputTextArea id="description" @bind-Value="newEvent.Description" rows="3" class="form-textarea" />
                <ValidationMessage For="@(() => newEvent.Description)" class="text-sm text-red-600 mt-1" />
            </div>
        </div>

        <!-- TICKET TYPES SECTION -->
        <h2 class="section-title">2. Ticket Types</h2>
        
        <div class="ticket-type-section">
            @for (int i = 0; i < newEvent.TicketTypes.Count; i++)
            {

                var ticket = newEvent.TicketTypes.ElementAt(i);
                
                var ticketNameId = string.Format("ticketName{0}", i);
                var ticketPriceId = string.Format("ticketPrice{0}", i);
                var ticketQuotaId = string.Format("ticketQuota{0}", i);

                <div class="ticket-type-item">
                    <h3 class="ticket-item-title">Ticket #@(i + 1): @(string.IsNullOrEmpty(ticket.Name) ? "New Type" : ticket.Name)</h3>

                    <!-- Remove Button -->
                    <button type="button" @onclick="() => RemoveTicketType(ticket)" class="remove-ticket-btn">
                        <span class="oi oi-trash" aria-hidden="true">X</span>
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                        <!-- Ticket Name -->
                        <div>
                            <label for="@ticketNameId" class="form-label">Name</label>
                            <!-- REVISÃO RZ9986: Usa @ticketNameId diretamente -->
                            <InputText id="@ticketNameId" @bind-Value="ticket.Name" class="form-input" />
                            <ValidationMessage For="@(() => ticket.Name)" class="validation-message" />
                        </div>

                        <!-- Price -->
                        <div>
                            <label for="@ticketPriceId" class="form-label">Price ($)</label>
                            <!-- REVISÃO RZ9986: Usa @ticketPriceId diretamente -->
                            <InputNumber id="@ticketPriceId" @bind-Value="ticket.Price" class="form-input" />
                            <ValidationMessage For="@(() => ticket.Price)" class="validation-message" />
                        </div>

                        <!-- Quota -->
                        <div>
                            <label for="@ticketQuotaId" class="form-label">Quota/Quantity</label>
                            <!-- REVISÃO RZ9986: Usa @ticketQuotaId diretamente -->
                            <InputNumber id="@ticketQuotaId" @bind-Value="ticket.Quota" class="form-input" />
                            <ValidationMessage For="@(() => ticket.Quota)" class="validation-message" />
                        </div>
                    </div>
                </div>
            }

            <button type="button" @onclick="AddTicketType" class="btn-add-ticket">
                 Add Ticket Type
            </button>
        </div>

        <!-- Error/Success Message -->
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="mt-6 p-4 @(isSuccess ? "bg-green-100 border-green-400 text-green-700" : "bg-red-100 border-red-400 text-red-700") border rounded-lg" role="alert">
                @statusMessage
            </div>
        }

        <!-- ACTION BUTTONS -->
        <div class="mt-8 pt-4 border-t flex justify-end space-x-4">
            <button type="button" @onclick="() => NavManager.NavigateTo(eventRoute)" class="btn-primary">
                Cancel
            </button>
            <button type="submit" disabled="@isCreating" class="btn-primary">
                @if (isCreating)
                {
                    <span class="animate-pulse">Creating...</span>
                }
                else
                {
                    <span>Save Event</span>
                }
            </button>
        </div>

    </EditForm>
</div>

@code {
    string eventRoute = "/events";
    
    [Inject]
    public EventService EventService { get; set; } = default!;

    [Inject]
    public NavigationManager NavManager { get; set; } = default!;

    private Event newEvent = new Event {
        StartDate = DateTime.Now.Date.AddDays(7).AddHours(10), 
        EndDate = DateTime.Now.Date.AddDays(7).AddHours(18),
        TicketTypes = new List<TicketType> { new TicketType() }
    };

    private bool isCreating = false;
    private string statusMessage = string.Empty;
    private bool isSuccess = false;

    // CORREÇÃO CS1662: Alterado de 'void' para 'Task'
    private Task AddTicketType()
    {
        newEvent.TicketTypes.Add(new TicketType());
        return Task.CompletedTask;
    }

    // CORREÇÃO CS1662: Alterado de 'void' para 'Task'
    private Task RemoveTicketType(TicketType ticket)
    {
        if (newEvent.TicketTypes.Count > 1)
        {
            newEvent.TicketTypes.Remove(ticket);
        }
        else
        {
            statusMessage = "An event must have at least one ticket type.";
            isSuccess = false;
        }
        return Task.CompletedTask;
    }

    private async Task HandleCreateEvent()
    {
        isCreating = true;
        statusMessage = string.Empty;
        isSuccess = false;

        // Validation for minimum ticket types
        // NOTA: Para ICollection<T> o Any() funciona corretamente sem Linq.
        if (!newEvent.TicketTypes.Any(t => !string.IsNullOrEmpty(t.Name)))
        {
            statusMessage = "You must add and fill in at least one ticket type.";
            isCreating = false;
            return;
        }

        try
        {
            var createdEvent = await EventService.CreateEventAsync(newEvent);

            isSuccess = true;
            statusMessage = $"Event '{createdEvent.Name}' created successfully!";
            
            await Task.Delay(2000); 
            NavManager.NavigateTo(eventRoute);
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error creating event: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }
}