@page "/events/{EventId:int}"
@using EventBookingSystem.Models
@using EventBookingSystem.Data
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using System.Linq

@*
    Componente para visualizar detalhes do evento e permitir o registro/reserva.
*@

<PageTitle>Event Details</PageTitle>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    
                    @if (isLoading)
                    {
                        <div class="text-center py-5 text-primary">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading event details...</p>
                        </div>
                    }
                    else if (Event == null)
                    {
                        <div class="alert alert-danger text-center py-4" role="alert">
                            <h4 class="alert-heading">Event Not Found</h4>
                            <p class="mb-0">The event you are looking for does not exist or has been removed.</p>
                        </div>
                    }
                    else
                    {
                        <header class="pb-3 border-bottom mb-4">
                            <h1 class="display-5 fw-bold text-dark mb-1">@Event.Name</h1>
                            
                            <p class="lead text-primary fw-semibold">
                                <span class="oi oi-calendar me-2" aria-hidden="true"></span>
                                @Event.StartDate.ToString("dd MMMM yyyy HH:mm") - @Event.EndDate.ToString("HH:mm")
                            </p>
                        </header>

                        <section class="mb-5">
                            <p class="text-secondary mb-4 whitespace-pre-line">@Event.Description</p>
                            
                            <div class="row text-muted">
                                <div class="col-md-6 d-flex align-items-center mb-2">
                                    <span class="oi oi-map-marker me-2 text-primary" aria-hidden="true"></span>
                                    <span class="fw-semibold text-dark">Location:</span> 
                                    <span class="ms-1">@Event.Location</span>
                                </div>
                                <div class="col-md-6 d-flex align-items-center mb-2">
                                    <span class="oi oi-people me-2 text-primary" aria-hidden="true"></span>
                                    <span class="fw-semibold text-dark">Capacity:</span> 
                                    <span class="ms-1">@Event.MaxCapacity</span>
                                </div>
                            </div>
                        </section>

                        <h2 class="h3 fw-bold text-dark mt-4 pt-4 border-top">Make Your Reservation</h2>

                        <EditForm Model="@registrationModel" OnValidSubmit="HandleRegistrationSubmit" FormName="RegistrationForm">
                            <DataAnnotationsValidator />
                            
                            <fieldset class="p-3 my-4 border rounded bg-light">
                                <legend class="float-none w-auto px-2 fs-5 fw-semibold text-dark">Your Details</legend>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fullName" class="form-label fw-semibold">Your Full Name</label>
                                        <InputText id="fullName" @bind-Value="registrationModel.FullName" class="form-control" />
                                        <ValidationMessage For="@(() => registrationModel.FullName)" class="text-danger small" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label fw-semibold">Your Best Email</label>
                                        <InputText id="email" @bind-Value="registrationModel.Email" class="form-control" />
                                        <ValidationMessage For="@(() => registrationModel.Email)" class="text-danger small" />
                                    </div>
                                </div>
                            </fieldset>

                            <section class="mb-4">
                                <h3 class="h5 fw-semibold text-dark mb-3">Select Tickets</h3>
                                @foreach (var ticketType in Event.TicketTypes)
                                {
                                    // Cálculo de disponibilidade
                                    var totalSold = ticketType.Registrations.Sum(r => r.Quantity);
                                    var remainingQuota = ticketType.Quota - totalSold;
                                    var currentQuantity = Quantities.GetValueOrDefault(ticketType.Id);

                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 
                                        @(remainingQuota > 0 ? "bg-white border shadow-sm" : "bg-danger-subtle border-danger text-muted opacity-75")">
                                        
                                        <div class="flex-grow-1 p-2">
                                            <h4 class="mb-1 fw-bold text-dark">@ticketType.Name</h4>
                                            <p class="text-success fw-bold fs-5 mb-0">@ticketType.Price.ToString("C")</p>
                                        </div>
                                        
                                        <div class="d-flex align-items-center">
                                            @if (remainingQuota > 0)
                                            {
                                                // Definimos o limite máximo para 5 ou a cota restante, o que for menor.
                                                int maxAllowed = Math.Min(5, remainingQuota);

                                                <label for="qty-@ticketType.Id" class="form-label me-2 mb-0">Qty:</label>
                                                
                                                <input type="number"
                                                        id="@($"qty-{ticketType.Id}")"
                                                        @onchange="@((ChangeEventArgs e) => UpdateQuantity(ticketType.Id, e.Value?.ToString()))"
                                                        min="0"
                                                        max="@maxAllowed"
                                                        class="form-control w-auto text-center" style="max-width: 80px;" />
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger text-uppercase p-2">SOLD OUT</span>
                                            }
                                        </div>
                                        
                                    </div>
                                    <p class="text-muted small ms-3 mt-n2 mb-3">
                                        @if (remainingQuota > 0)
                                        {
                                            <span>Available: **@remainingQuota** of @ticketType.Quota total spots.</span>
                                        }
                                        else
                                        {
                                            <span>Total Quota: @ticketType.Quota</span>
                                        }
                                    </p>
                                }
                            </section>

                            <div class="alert alert-primary d-flex justify-content-between align-items-center py-3 my-4 shadow-sm">
                                <span class="fs-4 fw-bold">Total Due:</span>
                                <span class="fs-3 fw-bolder">@TotalAmount.ToString("C")</span>
                            </div>

                            @if (!string.IsNullOrEmpty(statusMessage))
                            {
                                <div class="mt-4 alert @(isSuccess ? "alert-success" : "alert-danger")" role="alert">
                                    @statusMessage
                                </div>
                            }
                            
                            <div class="mt-4 d-flex justify-content-end">
                                <button type="submit" disabled="@(isProcessing || TotalAmount == 0)" 
                                        class="btn btn-primary btn-lg shadow-sm">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Processing...</span>
                                    }
                                    else
                                    {
                                        <span>Confirm Reservation (@TotalAmount.ToString("C"))</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    //
    // ** PARÂMETROS E INJEÇÕES **
    //
    [Parameter]
    public int EventId { get; set; }

    [Inject]
    public EventService EventService { get; set; } = default!;

    [Inject]
    public NavigationManager NavManager { get; set; } = default!;

    //
    // ** ESTADO DO COMPONENTE **
    //
    private Event? Event;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string statusMessage = string.Empty;
    private bool isSuccess = false;

    // Modelo para dados do comprador (melhor seria um RegistrationDTO/ViewModel)
    private Registration registrationModel = new Registration();

    // Dicionário para armazenar a quantidade selecionada para cada TicketType.
    private Dictionary<int, int> Quantities = new Dictionary<int, int>();

    //
    // ** PROPRIEDADES CALCULADAS **
    //
    // Propriedade Calculada para o valor total da compra.
    private decimal TotalAmount
    {
        get
        {
            if (Event == null) return 0;
            
            // Calcula o total somando (Preço * Quantidade) para cada tipo de ticket selecionado
            var total = Event.TicketTypes
                .Where(t => Quantities.ContainsKey(t.Id))
                .Sum(t => t.Price * Quantities[t.Id]);
                
            return total;
        }
    }

    //
    // ** MÉTODOS DE CICLO DE VIDA **
    //
    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        // Assume GetEventByIdAsync carrega todos os dados relacionados (TicketTypes, Registrations)
        Event = await EventService.GetEventByIdAsync(EventId);
        
        if (Event != null)
        {
            // Inicializa o dicionário de quantidades com 0 para cada tipo de ticket
            Quantities = Event.TicketTypes.ToDictionary(t => t.Id, t => 0);
        }
        isLoading = false;
    }
    
    //
    // ** MÉTODOS DE MANIPULAÇÃO DE EVENTOS **
    //

    // Método para atualizar manualmente o dicionário de quantidade a partir da entrada HTML
    private void UpdateQuantity(int ticketTypeId, string? value)
    {
        // Tenta analisar o valor como um inteiro
        if (int.TryParse(value, out int newQuantity))
        {
            // Aplica limite mínimo (0)
            newQuantity = Math.Max(0, newQuantity);
            
            // Re-aplica limite máximo baseado na cota/limite de exibição
            var ticketType = Event!.TicketTypes.First(t => t.Id == ticketTypeId);
            var totalSold = ticketType.Registrations.Sum(r => r.Quantity);
            var remainingQuota = ticketType.Quota - totalSold;
            
            // Limita a um máximo de 5 ou a cota restante
            int maxAllowed = Math.Min(5, remainingQuota);
            newQuantity = Math.Min(newQuantity, maxAllowed);
            
            // Atualiza o dicionário
            Quantities[ticketTypeId] = newQuantity;
            
            // Força a re-renderização para atualizar TotalAmount e o valor do campo de entrada (caso tenha sido truncado por maxAllowed)
            StateHasChanged(); 
        }
        else if (string.IsNullOrEmpty(value))
        {
             // Trata o caso de campo vazio como 0
             Quantities[ticketTypeId] = 0;
             StateHasChanged();
        }
    }

    private async Task HandleRegistrationSubmit()
    {
        // 1. Validação de pré-requisitos
        if (TotalAmount == 0)
        {
            statusMessage = "Please select at least one ticket.";
            isSuccess = false;
            return;
        }

        // 2. Início do processamento
        isProcessing = true;
        statusMessage = string.Empty;
        isSuccess = false;

        var registrationsToCreate = new List<Registration>();

        // 3. Validação final da cota e construção dos objetos
        foreach (var kvp in Quantities.Where(q => q.Value > 0))
        {
            var ticketTypeId = kvp.Key;
            var quantity = kvp.Value;

            // Busca o tipo de ticket do evento carregado
            var ticketType = Event!.TicketTypes.First(t => t.Id == ticketTypeId);
            var totalSold = ticketType.Registrations.Sum(r => r.Quantity);
            var remainingQuota = ticketType.Quota - totalSold;

            if (quantity > remainingQuota)
            {
                statusMessage = $"Error: Quantity {quantity} exceeds available quota ({remainingQuota}) for '{ticketType.Name}'. Please refresh the page.";
                isProcessing = false;
                return;
            }

            // Cria um novo objeto de registro para cada tipo de ticket selecionado
            registrationsToCreate.Add(new Registration
            {
                TicketTypeId = ticketTypeId,
                FullName = registrationModel.FullName,
                Email = registrationModel.Email,
                Quantity = quantity,
                RegistrationDate = DateTime.Now
                // Observação: EventId pode ser preenchido aqui se a entidade Registration tiver essa propriedade.
            });
        }
        
        // 4. Execução da transação
        try
        {
            await EventService.AddRegistrationsAsync(registrationsToCreate);
            isSuccess = true;
            statusMessage = $"Reservation of {registrationsToCreate.Sum(r => r.Quantity)} tickets for '{Event!.Name}' completed successfully! Total: {TotalAmount.ToString("C")}";
            
            // 5. Reset do formulário e recarregamento dos dados
            registrationModel = new Registration(); // Limpa os campos de nome/e-mail
            await OnParametersSetAsync(); // Recarrega o evento para refletir a nova cota e zera Quantities
        }
        catch (Exception ex)
        {
            isSuccess = false;
            // Melhorar o tratamento de exceções (por exemplo, erros de concorrência ou API)
            statusMessage = $"Error processing reservation: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}