@page "/events"
@using EventBookingSystem.Models
@using EventBookingSystem.Data
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
<!--

Component that displays the list of created events.

Allows you to view the details of an event.
-->

<PageTitle>Manage Events</PageTitle>

<div class="max-w-7xl mx-auto p-6 bg-white shadow-2xl rounded-xl mt-10">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800">Event Management</h1>
        
        <button @onclick="@(() => NavManager.NavigateTo("/events/create"))"
                class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center">
            <span class="oi oi-plus mr-2" aria-hidden="true"></span> Create New Event
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-10 text-gray-500">
            <p class="animate-spin inline-block oi oi-reload text-2xl"></p>
            <p class="mt-2">Loading events...</p>
        </div>
    }
    else if (events == null || !events.Any())
    {
        <div class="text-center py-10 border border-dashed border-gray-300 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-600">No Events Found</h2>
            <p class="text-gray-500 mt-2">It looks like you haven't created any events yet. Create your first one now!</p>
            <button @onclick="@(() => NavManager.NavigateTo("/events/create"))"
                    class="mt-4 px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-200">
                Create Event
            </button>
        </div>
    }
    else
    {
        <div class="overflow-x-auto bg-gray-50 rounded-lg shadow-inner">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            Event Name
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            Location
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            Data
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            Tickets Sold
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var eventItem in events)
                    {
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                @eventItem.Name
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @eventItem.Location
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @eventItem.StartDate.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @GetTotalRegistrations(eventItem) / @eventItem.MaxCapacity
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="/events/@eventItem.Id" class="text-indigo-600 hover:text-indigo-900 transition duration-150 mr-3">
                                    View Details
                                </a>
                                <!-- Futuro link para edição: <a href="/events/edit/@eventItem.Id" class="text-gray-600 hover:text-gray-900">Editar</a> -->
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Inject]
    public EventService EventService { get; set; } = default!;

    [Inject]
    public NavigationManager NavManager { get; set; } = default!;

    private List<Event>? events;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // CORREÇÃO: Usando GetEventsAsync() para corresponder ao EventService
            events = await EventService.GetEventsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading events: {ex.Message}");
            events = new List<Event>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private int GetTotalRegistrations(Event eventItem)
    {
        // Calcula o total de registros somando as quantidades em cada TicketType
        return eventItem.TicketTypes
                        .SelectMany(tt => tt.Registrations)
                        .Sum(r => r.Quantity);
    }
}